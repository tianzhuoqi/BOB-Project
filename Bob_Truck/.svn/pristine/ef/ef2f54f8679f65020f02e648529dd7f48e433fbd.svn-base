local Building = class("Building")

local clsBuildingObjectMod = require("Game/Module/SUniverse/UnivObject/BuildingObjectMod")  --描述将要建造的建筑
local resPath = 'ModelFBX/Solarsystem/Buildings/'
local UnityCamForwardCastFloor = GameObjectUtil.CamForwardCastFloor
function Building:ctor(BuildingData)
    self.planetaryProxy = Facade:RetrieveProxy(NotiConst.Proxy_Planetary)
    self.storehouseProxy = Facade:RetrieveProxy(NotiConst.Proxy_Storehouse)
    self.data = BuildingData
    self.buildingConfigData = DATA_BUILDING[self.data.buildingConfigId]
    local type = self.planetaryProxy:GetBuildingType(self.data.buildingConfigId)
    self.shipTable = {}
end

-- 创建planet对象并显示，返回obj
function Building:BuildBuilding(planetContainer,gridId)
    if self.data == nil then
        LogDebug("BuildingData is nil!!")
    end

    local pathName = resPath

    pathName = pathName..DATA_BUILDING[self.data.buildingConfigId][DATA_BUILDING.EVar['prefab_name_s']]..'.prefab'

    local buildingPrefab = ManagerResourceModule.LuaLoadBundle(pathName)
    self.buildingGo = UnityEngine.GameObject.Instantiate(buildingPrefab)
    self.buildingGo.transform.parent = planetContainer.transform
    self.gridId = gridId

    local xy = self:GetBuildingCenter()
    NGameObjectUtil.SetLocalPosition(self.buildingGo, xy.x, 0, xy.y)
    NGameObjectUtil.SetScale(self.buildingGo, 0.1, 0.1, 0.1)

    if self.data.status == common_pb.CREATE then
        local size = self:GetBldgSize()
        local path = ''
        if size == 1 then
            path = 'ModelFBX/Solarsystem/Buildings/build_2X2/build_2X2.prefab'
        elseif size == 2 then
            path = 'ModelFBX/Solarsystem/Buildings/build_3X3/build_3X3.prefab'
        elseif size == 3 then
            path = 'ModelFBX/Solarsystem/Buildings/build_4X4/build_4X4.prefab'
        end
        local modelAnim = ManagerResourceModule.LuaLoadBundle(path)
        self.modelAnimGo = UnityEngine.GameObject.Instantiate(modelAnim)
        NGameObjectUtil.SetScale(self.modelAnimGo, 0.1, 0.1, 0.1)
        self.modelAnimGo.transform.parent = self.buildingGo.transform
        NGameObjectUtil.SetLocalPosition(self.modelAnimGo, 0, 0, 0)
        NGameObjectUtil.SetScale(self.buildingGo, 0.07, 0.07, 0.07)
    end

    local buildingSize = self:GetBldgSize() + 1
    for i = 1, buildingSize do
        for j = 1, buildingSize do
            self.planetaryProxy:AddGridsUsedByGridId(gridId - (i - 1) * 1000 - (j - 1))
        end
    end

    local NLuaClickEvent = NLuaClickEvent.Get(self.buildingGo)
    NLuaClickEvent:Add3DClick(self, self.OnClick)

    local type = self.planetaryProxy:GetBuildingType(self.data.buildingConfigId)
    if type == common_pb.SPACESTATION or type == common_pb.POWERPLANT then -- 基地
        local powerRangePrefab = ManagerResourceModule.LuaLoadBundle('ParticleEffects/powerRange.prefab')
        self.powerRangegGo = UnityEngine.GameObject.Instantiate(powerRangePrefab)
        self.powerRangegGo.transform.parent = self.buildingGo.transform.parent
        local buildingCenter = self:GetBuildingCenter()
        local powerSupplyRange = self:GetPowerSupplyRange()

        NGameObjectUtil.SetPosition(self.powerRangegGo, buildingCenter.x, 0, buildingCenter.y)
        NGameObjectUtil.SetScale(self.powerRangegGo, powerSupplyRange, powerSupplyRange, powerSupplyRange)
        local pos = self.buildingGo.transform.position - UnityCamForwardCastFloor()
        local body = {x = pos.x, y = pos.z}
        Facade:SendNotification(NotiConst.Notify_InitCameraPos, body)
        self.powerRangegGo:SetActive(false)
    end

    return self.buildingGo
end

function Building:MovePos(gridId)
    local buildingSize = self:GetBldgSize() + 1
    for i = 1, buildingSize do
        for j = 1, buildingSize do
            self.planetaryProxy:RemoveGridsUsedByGridId(self.gridId - (i - 1) * 1000 - (j - 1))
        end
    end

    self.gridId = gridId

    local xy = self:GetBuildingCenter()
    NGameObjectUtil.SetLocalPosition(self.buildingGo, xy.x, 0, xy.y)
    NGameObjectUtil.SetScale(self.buildingGo, 0.1, 0.1, 0.1)

    for i = 1, buildingSize do
        for j = 1, buildingSize do
            self.planetaryProxy:AddGridsUsedByGridId(self.gridId - (i - 1) * 1000 - (j - 1))
        end
    end
end

function Building:IsShowPowerRangeg(isShow)
    if self.powerRangegGo ~= nil then
        self.powerRangegGo:SetActive(isShow)
    end
end

function Building:InitShip(shipData)
    for i = 1, #self.shipTable do
        self.shipTable[i].go:Destroy()
    end
    self.shipTable = {}
    for i = 1, #shipData do
        local shipPrefab = ManagerResourceModule.LuaLoadBundle('ModelFBX/ship/w_ship_00101.prefab')
        shipGo = UnityEngine.GameObject.Instantiate(shipPrefab)
        shipGo.transform.parent = self.buildingGo.transform
        NGameObjectUtil.SetLocalPosition(shipGo, i * 10, 0, i * 10)
        local data = {shipData = shipData, go = shipGo}
        table.insert( self.shipTable, data)
    end
end

function Building:OnClick()
    Facade:SendNotification(NotiConst.Notify_CloseEditBuildingMod)

    local isContinue = self:ReceivingJudgment()
    if not isContinue then
        return
    end
    self.planetaryProxy:SetCurBuildingOper(
        {
            uid = GetServerTimeStamp(),
            nodeId = self.planetaryProxy:GetPlanetaryId(),
            targetBuilding = self.data.id,
            configId = self.data.buildingConfigId,
            type = 0,
            building = self,
            dynamicData = {}
        }
    )

    Facade:ReplacePanel("BuildingInteractivePanel")
end

function Building:ShowBuildingObjMod()
    local body = {buildingConfigId = self.data.buildingConfigId, gridId = self.gridId, id = self.data.id}
    Facade:SendNotification(NotiConst.Notify_PlanetChooseBuilding, body)

    local buildingSize = self:GetBldgSize() + 1
    for i = 1, buildingSize do
        for j = 1, buildingSize do
            self.planetaryProxy:RemoveGridsUsedByGridId(self.gridId - (i - 1) * 1000 - (j - 1))
        end
    end
    if self.buildingGo ~= nil then
        self.buildingGo:SetActive(false)
    end
end

function Building:CloseBuildingObjMod()
    local buildingSize = self:GetBldgSize() + 1
    for i = 1, buildingSize do
        for j = 1, buildingSize do
            self.planetaryProxy:AddGridsUsedByGridId(self.gridId - (i - 1) * 1000 - (j - 1))
        end
    end
    if self.buildingGo ~= nil then
        self.buildingGo:SetActive(true)
    end
end

function Building:Destroy()
    if self.modelAnimGo ~= nil then
        self.modelAnimGo:Destroy()
        self.modelAnimGo = nil
    end

    if self.buildingGo ~= nil then
        local buildingSize = self:GetBldgSize() + 1
        for i = 1, buildingSize do
            for j = 1, buildingSize do
                self.planetaryProxy:RemoveGridsUsedByGridId(self.gridId - (i - 1) * 1000 - (j - 1))
            end
        end

        self.buildingGo:Destroy()
        self.buildingGo = nil
    end

    if self.powerRangegGo ~= nil then
        self.powerRangegGo:Destroy()
        self.powerRangegGo = nil
    end
end

function Building:ReceivingJudgment()
    local type = self.planetaryProxy:GetBuildingType(self.data.buildingConfigId)
    if type == common_pb.SURFCOL or type == common_pb.REFINERY or type == common_pb.HULLFACT then -- 地表采集
        local isShow = self.planetaryProxy:GetHexHudInfoState(self.data.pos)
        local nodeId = self.planetaryProxy:GetPlanetaryId()
        local isFull = self.storehouseProxy:IsStorehouseFull(nodeId)
        local isCanReceive = function(buildingId)
            local time = GetServerTimeStamp()
            local buildData = self.planetaryProxy:GetBuildingDataById(buildingId)
            if buildData ~= nil and buildData.getItemTime ~= nil and buildData.getItemTime ~= -1 and buildData.getItemTime/1000 < time then
                return true
            else
                return false
            end
        end
        if isFull and isShow then
            return false
        elseif not isFull and isShow and isCanReceive(self.data.id) then
            return false
        end
    end
    return true
end

--建筑体量
function Building:GetBldgSize()
    return self.buildingConfigData[DATA_BUILDING.EVar.bldg_size_n]
end

--获取供电范围直径
function Building:GetPowerSupplyRange()
    local affact_rng = self.buildingConfigData[DATA_BUILDING.EVar.affact_rng_n]
    affact_rng = math.floor(self.planetaryProxy:GetValueAfterAddition(affact_rng,"BUILDING","affact_rng"))
    return affact_rng * 2
end

--根据gridId获取建筑点
function Building:GetBuildingPosByGridId(gridId)
    local x = (gridId - gridId % 1000) / 1000 - 55
    local y = gridId % 1000 - 55
    return { x = x, y = y }
end

--获取建筑中心点
function Building:GetBuildingCenter()
    local bldgSize = self:GetBldgSize()
    local buildingPos = self:GetBuildingPosByGridId(self.gridId)
    local x = buildingPos.x - bldgSize * 0.5
    local y = buildingPos.y - bldgSize * 0.5
    return { x = x, y = y}
end

--是否在供电范围
function Building:IsInPowerSupplyRange(centerPos)
    local buildingCenter = self:GetBuildingCenter()
    local powerSupplyRange = self:GetPowerSupplyRange() * 0.5
    local distanceSq = (centerPos.x - buildingCenter.x) * (centerPos.x - buildingCenter.x) + (centerPos.y - buildingCenter.y) * (centerPos.y - buildingCenter.y) - powerSupplyRange * powerSupplyRange
    return distanceSq <= 0
end

return Building